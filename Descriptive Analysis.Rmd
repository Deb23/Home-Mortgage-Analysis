---
title: "Descriptive Analysis"
author: "Debasmita Basak"
date: "October 30, 2016"
output: word_document
---

```{r}

setwd("C:/Users/debas/Documents/CapitalOne")

library(sqldf)
library(ggplot2)
library(shiny)
library(scales)
library(ggthemes)
library(plyr)

source("HMDA_API.R")

hmda<-hmda_init()

```
Loan Distribution($ USD) over time:

```{r}
tg <- sqldf('select As_of_Year as Year,State,sum(Loan_Amount_000)/1000 as loan_originating from hmda  group by As_of_Year,State')

ggplot(data=tg, aes(x=Year, y=loan_originating, group=State, colour=State)) + theme_economist()+scale_colour_economist()+
    geom_line(size=1) +
    geom_point(size=2) +
    ggtitle("Loan Originating by Year") +
    labs(x="Year",y="Loans Originating [in Million $]")+
    scale_x_continuous(breaks = tg$Year)

```
Observation: 

We can see that for all the states, the amount of Loan Origination has gradually dropped over the period of 3 years. However, for Wyoming, Delaware and Washington DC , the drop is very gradual signifying very little change. But for Maryland 
and Virginia, there is a sharp decline. We should further investigate whether this drop was for a particular reason.

Loan Distribution by Loan Type(Refinance, Purchase) for MD and VA
```{r}
md_va <- subset(hmda,State == c("VA","MD"))
tg1 <- sqldf('select As_of_Year as Year,Loan_Purpose_Description as Type,sum(Loan_Amount_000)/1000000 as loan_originating from md_va  group by Year,Loan_Purpose_Description')
  
ggplot(tg1, aes(x=Year, y=loan_originating, fill=Type)) + theme_economist()+scale_colour_economist()+
    geom_bar(stat="identity") +     
    guides(fill=guide_legend(reverse=TRUE)) +         # reverse legend
    ggtitle("Loan Originating by Loan Purpose 
        (Maryland and Virginia)") +
    labs(x="Year",y="Loans Originating [in Billion $]")+
    geom_text(aes(label = loan_originating), size = 3, hjust = 0.5, vjust = 3, position ="stack") +                                                
    scale_fill_brewer(palette="Paired")               # colour palette
```

Observation: 

From the above chart we can see that over the period of 3 years, the drop in overall Loan Origination ($Value) decreased mainly due to sharp decline in "Refinance" type loans. Refinance loans drecreased by 66% (~16 Billion $) from 2012-2013 and by 56% (~19 Billion $) from 2013-2014.  However, "Purchase" type loans have slightly increased in net amount.

Probable causes would be that borrowers are more concerned about the closing costs associated to refinancing than the actual mortgage interest rates. However, to confirm this hypothesis, we would need more data regarding the interest rates for each application, loan origination fee, term length etc.

Another aspect that might affect the loan distribution is the Housing Market. We can analyse the changes in Housing market from 2012-2014.

Single Family House Owners trend over time
```{r}
tg2 <- sqldf('select distinct As_of_Year as Year, State, MSA_MD, Census_Tract_Number as ct, Number_of_Owner_Occupied_Units as home_owners from hmda')
tg3 <- sqldf('select Year, State, MSA_MD, sum(home_owners) as home_owners from tg2 group by Year, State, MSA_MD')
tg4 <- sqldf('select Year, State, sum(home_owners) as home_owners from tg3 group by Year, State')
  
ggplot(data=tg4, aes(x=Year, y=as.integer(home_owners)/1000000, group=State, colour=State)) + theme_economist_white()+scale_color_economist()+
    geom_line(size=1) +
    geom_point() +
    ggtitle("Home Owners by Year") +
    labs(x="Year",y="Home Owners [in Millions]")+
    scale_x_continuous(breaks = tg4$Year)+
    scale_y_continuous(breaks = seq.int(0,2,0.4))

```
Observation: 

The number of owner occupied houses (for 1-4 single family) is nearly constant over the years. Thereby, given the data that we have, we can conclude that Number of Owner-Occupied houses doesn't impact the loan purchases for the years given.

Analysing Loan distribution by Income Category of Applicant

We have segregated the applicants into 3 Income Categories based on % of Median Family Income of the MSD they belong to:
<80% of Median Family Income - Lower-Moderate Income[LMI] 
>80% and <120% of Median Family Income - Middle-UpperMiddle [MUM]
>120% of Median Family Income - Upper Income [UI]

```{r}
 td5 <- sqldf('select State, IncomeCategory, sum(Loan_Amount_000) as loan_originating from hmda group by State, IncomeCategory')
  
    ggplot(td5,aes(x = State, y = loan_originating,fill = IncomeCategory)) + theme_economist()+
    geom_bar(position = "fill",stat = "identity") + scale_colour_economist()+
    scale_y_continuous(labels = percent_format())+
    ggtitle("% Loan Origination by Income Category") +
    labs(x="State",y="Loan Origination")
```

Observation: 

We can see that all the states especially DC, the bulk of Loan Originated ($) is generated by Upper Income category applicants. On the other hand the LMI and MUM category of applicants end up buying loans of almost equivalent net amount.

Recommendation:
Recommendation: 
1. Based on the data we can see that Maryland and Virginia are the most optimal markets among these 5 states for introducing home loan products owing to their consistently high housing market trend and higher Loan Origination trend as compared to other states. However, both these states have seen a fall in Refinance loans recently. 


2. However, we need more data to analyze the actual reason behind it. Data related to credit rating of applicant, default pays, interest rates and term length would be very useful in identifying the market trend accurately. 

